<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>موقف نزول الصيادلة</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header .header-title {
            font-weight: 700;
            font-size: 26px;
            color: #2c3e50;
        }

        .date-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }
        .date-controls .form-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        label {
            font-weight: 700;
            color: #34495e;
        }
        input[type="date"], select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #fff;
            font-family: 'Cairo', sans-serif;
        }
        #exportButton, #sessionsButton, #printButton {
            padding: 8px 15px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
        }
        #exportButton { background-color: #007bff; }
        #exportButton:hover { background-color: #0056b3; }
        #sessionsButton { background-color: #6c757d; }
        #sessionsButton:hover { background-color: #5a6268; }
        #printButton { background-color: #343a40; }
        #printButton:hover { background-color: #23272b; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: right;
            word-wrap: break-word;
        }
        th {
            background-color: #f2f2f2;
            font-size: 16px;
        }
        .col-seq { width: 50px; text-align: center; }
        .col-action { width: 80px; text-align: center; }
        
        .entry-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .entry-row input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: 'Cairo', sans-serif;
        }
        #addButton {
            padding: 10px 20px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            background-color: #28a745;
        }
        #addButton:hover {
            background-color: #218838;
        }
        #clearAllButton {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 4px 10px;
            font-size: 12px;
            font-family: 'Cairo', sans-serif;
            font-weight: bold;
        }
        #clearAllButton:hover {
             background-color: #c82333;
        }
        .remove-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 2px 9px;
            font-size: 12px;
            font-weight: bold;
            line-height: 1.5;
        }
        .remove-btn:hover {
            background-color: #c82333;
        }

        /* Autocomplete styles */
        .autocomplete {
            position: relative;
            flex: 1;
        }
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #fff;
            max-height: 200px;
            overflow-y: auto;
        }
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
        }
        .autocomplete-items div:hover, .autocomplete-active {
            background-color: #e9e9e9;
        }

        /* Sessions Panel Styles */
        #sessionsPanel {
            position: fixed;
            top: 0;
            left: -350px; 
            width: 320px;
            height: 100%;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: left 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        #sessionsPanel.open {
            left: 0;
        }
        .sessions-header {
            padding: 15px;
            background-color: #f7f7f7;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sessions-header h3 {
            margin: 0;
            font-size: 18px;
        }
        .close-panel-btn {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }
        .sessions-content {
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .sessions-list-container {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        #saveSessionBtn {
             width: 100%;
             padding: 10px;
             background-color: #28a745;
             color: white;
             border: none;
             border-radius: 5px;
             cursor: pointer;
             font-size: 16px;
             font-family: 'Cairo', sans-serif;
             margin-bottom: 15px;
        }
        #deleteAllSessionsBtn {
            width: 100%;
            padding: 8px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Cairo', sans-serif;
            margin-top: auto;
        }
        #deleteAllSessionsBtn:hover {
            background-color: #c82333;
        }
        #sessionsList {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #sessionsList li {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        #sessionsList .session-actions button {
            margin-left: 5px;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
        }
        .load-session-btn { background-color: #007bff; }
        .delete-session-btn { background-color: #dc3545; }
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            z-index: 999;
        }
        #overlay.active {
            display: block;
        }

        .print-only {
            display: none;
        }

        /* Print-specific Styles */
        @page {
            size: A4 portrait;
            margin: 1in;
        }

        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block;
            }
            body {
                background-color: #fff;
                padding: 0;
                margin: 0;
                font-family: 'Times New Roman', serif;
                font-size: 16pt;
            }
            p {
                margin: 0; 
                padding: 0; 
                line-height: 1.5;
            }
            .container {
                box-shadow: none;
                border: none;
                width: 100%;
                max-width: 100%;
                padding: 0;
                box-sizing: border-box;
            }
            table {
                font-size: 14pt;
                margin-top: 2rem;
                width: 100%;
            }
            th, td {
                border: 1px solid #000;
            }
            #print-footer {
                margin-top: 3rem;
                text-align: left;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="print-only">
        <p style="text-align: right;">السيد مدير مستشفى ام قصر المحترم</p>
        <p style="text-align: right;">السيد مدير القسم الفني المحترم</p>
        <br>
        <p style="text-align: center;">م/ موقف العمل الرسمي للصيادلة</p>
        <br>
        <p id="print-intro-text"></p>
    </div>

    <div class="header no-print">
        <p class="header-title">الموقف اليومي للصيادلة</p>
    </div>

    <div class="date-controls no-print">
        <div class="form-group">
            <label for="logDay">اليوم:</label>
            <select id="logDay" name="logDay">
                <option value="0">الأحد</option>
                <option value="1">الاثنين</option>
                <option value="2">الثلاثاء</option>
                <option value="3">الأربعاء</option>
                <option value="4">الخميس</option>
            </select>
        </div>
        <div class="form-group">
            <label for="logDate">التاريخ:</label>
            <input type="date" id="logDate" name="logDate">
        </div>
        <button id="exportButton">تصدير وحفظ</button>
        <button id="sessionsButton">الجلسات</button>
        <button id="printButton">طباعة</button>
    </div>

    <hr class="no-print">

    <div id="entryForm" class="no-print">
        <div class="entry-row">
            <div class="autocomplete">
                <input type="text" id="pharmacistName" placeholder="اسم الصيدلاني..." autocomplete="off">
            </div>
            <div class="autocomplete">
                <input type="text" id="destination" placeholder="جهة النزول..." autocomplete="off">
            </div>
            <div class="autocomplete">
                <input type="text" id="purpose" placeholder="الغرض من النزول..." autocomplete="off">
            </div>
            <button id="addButton">إضافة للقائمة</button>
        </div>
    </div>

    <table id="logTable">
        <thead>
            <tr>
                <th class="col-seq">ت</th>
                <th>الاسم</th>
                <th>جهة النزول</th>
                <th>الغرض من النزول</th>
                <th class="col-action no-print">
                    <button id="clearAllButton">حذف الكل</button>
                </th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
    
    <div id="print-footer" class="print-only">
        <div style="display: inline-block; text-align: center;">
            <p>مدير شعبة الصيدلة</p>
            <p>الصيدلاني</p>
            <p>مصطفى مهدي ناصر</p>
        </div>
    </div>
</div>

<div id="sessionsPanel" class="no-print">
    <div class="sessions-header">
        <h3>الجلسات المحفوظة</h3>
        <button class="close-panel-btn">&times;</button>
    </div>
    <div class="sessions-content">
        <button id="saveSessionBtn">حفظ الجلسة الحالية</button>
        <div class="sessions-list-container">
            <ul id="sessionsList">
                </ul>
        </div>
        <button id="deleteAllSessionsBtn">حذف جميع الجلسات</button>
    </div>
</div>
<div id="overlay" class="no-print"></div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- State Signature Variable ---
    let lastSavedStateSignature = null;

    // --- Element References ---
    const logDateInput = document.getElementById('logDate');
    const logDaySelect = document.getElementById('logDay');
    const addButton = document.getElementById('addButton');
    const clearAllButton = document.getElementById('clearAllButton');
    const tableBody = document.querySelector("#logTable tbody");
    const nameInput = document.getElementById('pharmacistName');
    const destInput = document.getElementById('destination');
    const purposeInput = document.getElementById('purpose');
    const exportButton = document.getElementById('exportButton');
    const printButton = document.getElementById('printButton');
    
    // Sessions elements
    const sessionsButton = document.getElementById('sessionsButton');
    const sessionsPanel = document.getElementById('sessionsPanel');
    const closePanelBtn = document.querySelector('.close-panel-btn');
    const saveSessionBtn = document.getElementById('saveSessionBtn');
    const sessionsList = document.getElementById('sessionsList');
    const deleteAllSessionsBtn = document.getElementById('deleteAllSessionsBtn');
    const overlay = document.getElementById('overlay');


    // --- Date and Day Section ---
    function setInitialDate() {
        let today = new Date();
        let dayOfWeek = today.getDay();
        if (dayOfWeek === 5) { today.setDate(today.getDate() + 2); }
        else if (dayOfWeek === 6) { today.setDate(today.getDate() + 1); }
        dayOfWeek = today.getDay();
        logDateInput.valueAsDate = today;
        logDaySelect.value = dayOfWeek;
    }

    logDaySelect.addEventListener('change', function() {
        const selectedDay = parseInt(this.value);
        let date = new Date();
        const currentDay = date.getDay();
        const difference = selectedDay - currentDay;
        date.setDate(date.getDate() + difference);
        logDateInput.valueAsDate = date;
    });

    logDateInput.addEventListener('change', function() {
        let selectedDate = new Date(this.value);
        let dayOfWeek = selectedDate.getDay();
        if (dayOfWeek === 5 || dayOfWeek === 6) {
            alert("لا يمكن تحديد يومي الجمعة والسبت.");
            setInitialDate();
            return;
        }
        logDaySelect.value = dayOfWeek;
    });

    // --- Data Lists ---
    const pharmacists = ["مصطفى مهدي ناصر", "نور الدين حبيب علي", "مؤمل جميل حطاب", "نذير اسعد فرج", "حيدر علي محمد", "محمد علي طه", "محمد حنون محمد", "علي عدنان مجيد", "منال مهدي ناصر", "فاطمة لطيف ناصر", "سارة عادل محمد", "وسن مأمون حسين", "رند حسين عبد الكريم", "غدير مدرك حمودي", "تبارك عيسى جواد", "فتون عبد الحكيم هلال", "احمد فرحان نجم", "كوثر صالح حسن", "حسين عبدالعباس محمد", "عائشة شمس الدين"];
    const linkedPurposes = { "دائرة صحة البصرة": ["اجتماع مدراء شعب الصيدلة", "موقف سلامة المريض", "مراجعة شعبة الاجنحة الخاصة", "مراجعة قسم الامور الفنية", "مراجعة قسم الامور الادارية والمالية والقانونية"], "قسم الصيدلة": ["اجتماع مدراء شعب الصيدلة", "استحصال اعتذار وموافقة شراء مواد", "اجتماع المناقلات", "تسليم موقف الاستبيان الشهري", "تسليم تايد استلام ادوية", "تسليم تايد استلام مستلزمات طبية", "تسليم تايد استلام مواد مختبرية", "استلام طلبية ادوية", "استلام طلبية مواد مختبرية", "استلام طلبية مستلزمات طبية - مخازن المعقل"], "قسم الصحة العامة": ["استلام مواد تنظيم الاسرة", "مركز الاسنان التخصصي فحص مواد", "اجتماع مناقلات", "تسليم مسحات مختبرية"], "قسم العمليات وطب الطوارئ": ["تسليم موقف الادوية المنقذة للحياة", "تسليم موقف اللقاحات"], "الاسواق المحلية": ["شراء ادوية", "شراء مستلزمات طبية", "شراء مواد مختبرية", "شراء مواد اسنان"], "شعبة الرقابة الدوائية": ["تسليم موقف الميرونيم", "تسليم موقف المضادات الحياتية", "تسليم موقف التغيرات الفيزياوية", "تسليم موقف الالبومين", "تسليم موقف مقاومة الميكروبات"], "مركز الامراض الصدرية والتنفسية": ["تسليم نماذج مسحات", "استلام صبغات مختبرية"], "الشركة العامة للأدوية": ["استلام لقاحات", "تسليم تايد استلام لقاحات"], "قطاع الزبير للرعاية الصحية الاولية": ["استلام لقاحات الكبد الفيروسي للاطفال", "تسليم تايد استلام"], "قسم التفتيش": ["اجتماء مدراء شعب الصيدلة", "تسليم موقف الجرد المفاجئ", "استدعاء", "اتلاف ادوية"], "مستشفى الصدر التعليمي": ["مناقلة مواد", "مناقلة ادوية", "مناقلة مستلزمات طبية", "مناقلة لقاحات"], "مستشفى البصرة التعليمي": ["مناقلة مواد", "مناقلة ادوية", "مناقلة مستلزمات طبية", "مناقلة لقاحات"], "مستشفى الموانئ العام": ["مناقلة مواد", "مناقلة ادوية", "مناقلة مستلزمات طبية", "مناقلة لقاحات"], "مستشفى البصرة للنسائية والأطفال": ["مناقلة مواد", "مناقلة ادوية", "مناقلة مستلزمات طبية", "مناقلة لقاحات"], "مستشفى الفيحاء التعليمي": ["مناقلة مواد", "مناقلة ادوية", "مناقلة مستلزمات طبية", "مناقلة لقاحات"], "مستشفى الشفاء العام": ["مناقلة مواد", "مناقلة ادوية", "مناقلة مستلزمات طبية", "مناقلة لقاحات"], "مستشفى الزبير العام": ["مناقلة مواد", "مناقلة ادوية", "مناقلة مستلزمات طبية", "مناقلة لقاحات"], "مستشفى البصرة التخصصي لأمراض وجراحة القلب": ["مناقلة مواد", "مناقلة ادوية", "مناقلة مستلزمات طبية", "مناقلة لقاحات"], "مستشفى الطفل التخصصي": ["مناقلة مواد", "مناقلة ادوية", "مناقلة مستلزمات طبية", "مناقلة لقاحات"]};
    const destinations = Object.keys(linkedPurposes);
    const allPurposes = [...new Set(Object.values(linkedPurposes).flat())];

    // --- State Management ---
    function generateStateSignature() {
        const logDate = logDateInput.value;
        const entries = Array.from(tableBody.querySelectorAll('tr')).map(row => ({
            name: row.cells[1].textContent,
            destination: row.cells[2].textContent,
            purpose: row.cells[3].textContent,
        }));
        return JSON.stringify({ logDate, entries });
    }

    // --- Table Logic ---
    function updateSequence() {
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach((row, index) => {
            row.cells[0].textContent = index + 1;
        });
    }

    function addRow(name, destination, purpose) {
         if (!name || !destination || !purpose) {
            alert('يرجى ملء جميع الحقول.');
            return false;
        }
        const newRow = tableBody.insertRow();
        newRow.insertCell(0).classList.add('col-seq');
        newRow.insertCell(1).textContent = name;
        newRow.insertCell(2).textContent = destination;
        newRow.insertCell(3).textContent = purpose;
        const removeCell = newRow.insertCell(4);
        removeCell.classList.add('col-action', 'no-print');
        const removeButton = document.createElement('button');
        removeButton.textContent = 'X';
        removeButton.classList.add('remove-btn');
        removeButton.onclick = function() {
            this.parentNode.parentNode.remove();
            updateSequence();
        };
        removeCell.appendChild(removeButton);
        updateSequence();
        return true;
    }

    addButton.addEventListener('click', function() {
        const name = nameInput.value.trim();
        const destination = destInput.value.trim();
        const purpose = purposeInput.value.trim();
        let isDuplicate = false;
        const existingRows = tableBody.querySelectorAll('tr');
        for (const row of existingRows) {
            if (row.cells[1].textContent === name) {
                isDuplicate = true;
                break;
            }
        }
        if (isDuplicate) {
            alert('هذا الاسم موجود بالفعل في القائمة.');
            return; 
        }
        if(addRow(name, destination, purpose)) {
            nameInput.value = '';
            destInput.value = '';
            purposeInput.value = '';
            nameInput.blur(); 
        }
    });

    clearAllButton.addEventListener('click', function() {
        if (tableBody.rows.length > 0) {
            if (confirm('هل أنت متأكد من حذف جميع الأسماء في القائمة الحالية؟')) {
                tableBody.innerHTML = '';
            }
        }
    });
    
    // --- Autocomplete Section ---
    function closeAllAutocompleteLists() {
        const lists = document.getElementsByClassName("autocomplete-items");
        for (let i = lists.length - 1; i >= 0; i--) {
            lists[i].parentNode.removeChild(lists[i]);
        }
    }

    function autocomplete(inp, arr) {
        inp.dataSource = arr;
        let currentFocus;
        inp.addEventListener("input", function(e) {
            closeAllAutocompleteLists();
            const val = this.value;
            if (!val) { 
                this.dispatchEvent(new Event('focus', { bubbles: true }));
                return; 
            }
            currentFocus = -1;
            const list = document.createElement("DIV");
            list.setAttribute("id", this.id + "autocomplete-list");
            list.setAttribute("class", "autocomplete-items");
            this.parentNode.appendChild(list);
            for (let i = 0; i < this.dataSource.length; i++) {
                if (this.dataSource[i].toUpperCase().startsWith(val.toUpperCase())) {
                    const item = document.createElement("DIV");
                    item.innerHTML = "<strong>" + this.dataSource[i].substr(0, val.length) + "</strong>";
                    item.innerHTML += this.dataSource[i].substr(val.length);
                    item.innerHTML += "<input type='hidden' value='" + this.dataSource[i] + "'>";
                    item.addEventListener("click", function(e) {
                        inp.value = this.getElementsByTagName("input")[0].value;
                        inp.dispatchEvent(new Event('input', { bubbles: true }));
                        closeAllAutocompleteLists();
                    });
                    list.appendChild(item);
                }
            }
        });
        inp.addEventListener("focus", function(e) {
            closeAllAutocompleteLists();
            currentFocus = -1;
            const list = document.createElement("DIV");
            list.setAttribute("id", this.id + "autocomplete-list");
            list.setAttribute("class", "autocomplete-items");
            this.parentNode.appendChild(list);
            for (const optionText of this.dataSource) {
                 const item = document.createElement("DIV");
                 item.innerHTML = optionText;
                 item.innerHTML += "<input type='hidden' value='" + optionText + "'>";
                 item.addEventListener("click", function(e) {
                    inp.value = this.getElementsByTagName("input")[0].value;
                    inp.dispatchEvent(new Event('input', { bubbles: true }));
                    closeAllAutocompleteLists();
                 });
                 list.appendChild(item);
            }
        });
        inp.addEventListener("keydown", function(e) {
            let x = document.getElementById(this.id + "autocomplete-list");
            if (x) x = x.getElementsByTagName("div");
            if (e.keyCode == 40) { currentFocus++; addActive(x); } 
            else if (e.keyCode == 38) { currentFocus--; addActive(x); } 
            else if (e.keyCode == 13) { e.preventDefault(); if (currentFocus > -1) { if (x) x[currentFocus].click(); } }
        });
        function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            x[currentFocus].classList.add("autocomplete-active");
        }
        function removeActive(x) {
            for (let i = 0; i < x.length; i++) {
                x[i].classList.remove("autocomplete-active");
            }
        }
    }
    
    destInput.addEventListener('input', function() {
        const selectedDestination = this.value;
        const newPurposes = linkedPurposes[selectedDestination] || allPurposes;
        purposeInput.dataSource = newPurposes;
        purposeInput.value = '';
    });

    autocomplete(nameInput, pharmacists);
    autocomplete(destInput, destinations);
    autocomplete(purposeInput, allPurposes);

    document.addEventListener('click', function (e) {
        if (!e.target.closest('.autocomplete')) {
            closeAllAutocompleteLists();
        }
    });

    // --- SESSIONS LOGIC ---
    const SESSIONS_KEY = 'pharmacistLogSessions';

    function getSavedSessions() {
        return JSON.parse(localStorage.getItem(SESSIONS_KEY)) || [];
    }

    function saveSessions(sessions) {
        localStorage.setItem(SESSIONS_KEY, JSON.stringify(sessions));
    }

    function populateSessionsList() {
        const sessions = getSavedSessions();
        sessions.sort((a, b) => new Date(b.id) - new Date(a.id));
        sessionsList.innerHTML = ''; 
        if (sessions.length === 0) {
            sessionsList.innerHTML = '<li>لا توجد جلسات محفوظة.</li>';
        } else {
            sessions.forEach(session => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${session.displayName}</span>
                    <div class="session-actions">
                        <button class="load-session-btn" data-id="${session.id}">تحميل</button>
                        <button class="delete-session-btn" data-id="${session.id}">حذف</button>
                    </div>
                `;
                sessionsList.appendChild(li);
            });
        }
    }
    
    function saveCurrentSession() {
        const currentStateSignature = generateStateSignature();
        if (currentStateSignature === lastSavedStateSignature) {
            return 'no-change';
        }

        const logDate = logDateInput.value;
        const entries = [];
        tableBody.querySelectorAll('tr').forEach(row => {
            entries.push({
                name: row.cells[1].textContent,
                destination: row.cells[2].textContent,
                purpose: row.cells[3].textContent,
            });
        });

        const now = new Date();
        const day = logDaySelect.options[logDaySelect.selectedIndex].text;
        const newSession = {
            id: now.toISOString(),
            displayName: `${day} - ${now.toLocaleString('ar-EG', { dateStyle: 'short', timeStyle: 'short' })}`,
            logDate: logDate,
            entries: entries
        };

        let sessions = getSavedSessions();
        sessions.push(newSession);
        saveSessions(sessions);
        
        lastSavedStateSignature = currentStateSignature;
        return true;
    }

    function togglePanel(show) {
        if(show) {
            populateSessionsList();
            sessionsPanel.classList.add('open');
            overlay.classList.add('active');
        } else {
            sessionsPanel.classList.remove('open');
            overlay.classList.remove('active');
        }
    }

    sessionsButton.addEventListener('click', () => togglePanel(true));
    closePanelBtn.addEventListener('click', () => togglePanel(false));
    overlay.addEventListener('click', () => togglePanel(false));

    saveSessionBtn.addEventListener('click', () => {
        if (!logDateInput.value) {
            alert('الرجاء تحديد تاريخ الموقف أولاً.');
            return;
        }
        if (tableBody.rows.length === 0) {
            alert('لا يمكن حفظ جلسة فارغة.');
            return;
        }
        
        const result = saveCurrentSession();
        if (result === 'no-change') {
            alert('لم يتم العثور على تغييرات جديدة لحفظها.');
        } else if (result === true) {
            populateSessionsList();
        }
    });

    deleteAllSessionsBtn.addEventListener('click', () => {
        if (getSavedSessions().length > 0) {
            if (confirm('هل أنت متأكد من حذف جميع الجلسات المحفوظة؟\nلا يمكن التراجع عن هذا الإجراء.')) {
                saveSessions([]);
                populateSessionsList();
            }
        }
    });

    sessionsList.addEventListener('click', (e) => {
        const target = e.target;
        const sessionId = target.dataset.id;
        if (!sessionId) return;
        
        let sessions = getSavedSessions();

        if (target.classList.contains('load-session-btn')) {
            const sessionToLoad = sessions.find(s => s.id === sessionId);
            if (sessionToLoad) {
                logDateInput.value = sessionToLoad.logDate;
                logDateInput.dispatchEvent(new Event('change'));
                tableBody.innerHTML = '';
                sessionToLoad.entries.forEach(entry => {
                    addRow(entry.name, entry.destination, entry.purpose);
                });
                lastSavedStateSignature = generateStateSignature();
                togglePanel(false);
            }
        }

        if (target.classList.contains('delete-session-btn')) {
            const sessionToDelete = sessions.find(s => s.id === sessionId);
            if (confirm(`هل أنت متأكد من حذف جلسة:\n${sessionToDelete.displayName}؟`)) {
                let updatedSessions = sessions.filter(s => s.id !== sessionId);
                saveSessions(updatedSessions);
                populateSessionsList();
            }
        }
    });

    // --- PRINT LOGIC ---
    printButton.addEventListener('click', function() {
        const day = logDaySelect.options[logDaySelect.selectedIndex].text;
        const date = logDateInput.value;
        const printIntro = document.getElementById('print-intro-text');
        
        printIntro.innerHTML = `نرفع اليكم الموقف اليومي للصيادلة العاملين في وحدة الصيدلة في مستشفانا ليوم <b>${day}</b> التاريخ <b>${date}</b> للتفضل بالموافقة مع التقدير.....`;

        window.print();
    });

    // --- EXPORT TO WORD LOGIC ---
    exportButton.addEventListener('click', function() {
        const day = logDaySelect.options[logDaySelect.selectedIndex].text;
        const date = logDateInput.value;
        if (!date) {
             alert('الرجاء تحديد التاريخ قبل التصدير.');
             return;
        }
        if (tableBody.rows.length === 0) {
             alert('لا يمكن تصدير موقف فارغ. الرجاء إضافة صيدلاني واحد على الأقل.');
             return;
        }

        saveCurrentSession();

        const allHtmlRows = Array.from(tableBody.querySelectorAll('tr'));
        const chunkSize = 7;
        const chunks = [];
        for (let i = 0; i < allHtmlRows.length; i += chunkSize) {
            chunks.push(allHtmlRows.slice(i, i + chunkSize));
        }
        if (chunks.length === 0) chunks.push([]);

        let allPagesHtml = '';
        chunks.forEach((chunk, pageIndex) => {
            let tableHtml = `<table style="width:100%; border-collapse: collapse; table-layout: fixed;" border="1">
                <thead>
                    <tr style="background-color:#f2f2f2;">
                        <th style="padding: 8px; width: 10%;">ت</th>
                        <th style="padding: 8px; width: 30%;">الاسم</th>
                        <th style="padding: 8px; width: 30%;">جهة النزول</th>
                        <th style="padding: 8px; width: 30%;">الغرض من النزول</th>
                    </tr>
                </thead>
                <tbody>`;
            
            chunk.forEach(row => {
                tableHtml += `<tr>
                    <td style="padding: 8px; text-align: center;">${row.cells[0].textContent}</td>
                    <td style="padding: 8px; text-align: right;">${row.cells[1].textContent}</td>
                    <td style="padding: 8px; text-align: right;">${row.cells[2].textContent}</td>
                    <td style="padding: 8px; text-align: right;">${row.cells[3].textContent}</td>
                </tr>`;
            });

            const emptyRowsNeeded = chunkSize - chunk.length;
            for (let i = 0; i < emptyRowsNeeded; i++) {
                tableHtml += `<tr>
                    <td style="padding: 8px; text-align: center;">&nbsp;</td>
                    <td style="padding: 8px;">&nbsp;</td>
                    <td style="padding: 8px;">&nbsp;</td>
                    <td style="padding: 8px;">&nbsp;</td>
                </tr>`;
            }
            
            tableHtml += `</tbody></table>`;
            
            const pageBreak = (pageIndex < chunks.length - 1) ? '<br style="page-break-after: always;">' : '';
            allPagesHtml += `
                <div>
                    <div class="header">
                        <p>السيد مدير مستشفى ام قصر المحترم</p>
                        <p>السيد مدير القسم الفني المحترم</p>
                    </div>
                    <br>
                    <div class="subject">
                        <p>م/ موقف العمل الرسمي للصيادلة</p>
                    </div>
                    <br>
                    <div class="main-body">
                        <p>
                            نرفع اليكم الموقف اليومي للصيادلة العاملين في وحدة الصيدلة في مستشفانا ليوم <b>${day}</b> 
                            التاريخ <b>${date}</b> للتفضل بالموافقة مع التقدير.....
                        </p>
                    </div>
                    <br><br>${tableHtml}<br><br><br>
                    <div class="signature" style="text-align: left; padding-left: 50px;">
                        <div style="display: inline-block; text-align: center;">
                            <p>مدير شعبة الصيدلة</p>
                            <p>الصيدلاني</p>
                            <p>مصطفى مهدي ناصر</p>
                        </div>
                    </div>
                </div>${pageBreak}`;
        });

        const fullHtml = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
            <head>
                <meta charset='utf-8'>
                <title>موقف النزول</title>
                <style>
                    @page { size: A4 portrait; margin: 1in; }
                    body { font-family: 'Times New Roman', serif; direction: rtl; font-size: 16pt; }
                    p { margin: 0; padding: 0; line-height: 1.5; }
                    .header { text-align: right; }
                    .subject, .main-body { text-align: center; }
                    table { border-collapse: collapse; width: 100%; table-layout: fixed; font-size: 14pt; }
                    th, td { border: 1px solid black; padding: 8px; word-wrap: break-word; }
                </style>
            </head>
            <body>${allPagesHtml}</body>
            </html>`;

        const blob = new Blob(['\ufeff', fullHtml], { type: 'application/msword' });
        const url = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(fullHtml);
        const filename = `موقف نزول ${date}.doc`;
        const downloadLink = document.createElement("a");
        document.body.appendChild(downloadLink);
        
        if(navigator.msSaveOrOpenBlob ){
            navigator.msSaveOrOpenBlob(blob, filename);
        }else{
            downloadLink.href = url;
            downloadLink.download = filename;
            downloadLink.click();
        }
        document.body.removeChild(downloadLink);
    });

    // --- AUTO SAVE & LOAD LOGIC ---
    function loadLastState() {
        const lastStateJSON = localStorage.getItem('lastWorkingState');
        if (lastStateJSON) {
            try {
                const lastState = JSON.parse(lastStateJSON);
                if (lastState && lastState.logDate && lastState.entries) {
                    logDateInput.value = lastState.logDate;
                    logDateInput.dispatchEvent(new Event('change'));

                    tableBody.innerHTML = '';
                    lastState.entries.forEach(entry => {
                        addRow(entry.name, entry.destination, entry.purpose);
                    });
                    return true;
                }
            } catch (e) {
                console.error("Error parsing last working state:", e);
                return false;
            }
        }
        return false;
    }

    window.addEventListener('beforeunload', function() {
        localStorage.setItem('lastWorkingState', generateStateSignature());
    });


    // --- Initial Setup ---
    const didLoadState = loadLastState();
    if (!didLoadState) {
        setInitialDate();
    }
    lastSavedStateSignature = generateStateSignature();

});
</script>

</body>
</html>